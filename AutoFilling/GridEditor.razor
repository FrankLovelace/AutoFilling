@namespace AutoFilling

<div class="panel-controles">
    <div class="control-grupo">
        <label>Filas: <strong>@Filas</strong></label>
        <button class="btn" @onclick="() => CambiarDimensiones(1, 0)">+</button>
        <button class="btn" @onclick="() => CambiarDimensiones(-1, 0)">-</button>
    </div>

    <div class="control-grupo">
        <label>Columnas: <strong>@Columnas</strong></label>
        <button class="btn" @onclick="() => CambiarDimensiones(0, 1)">+</button>
        <button class="btn" @onclick="() => CambiarDimensiones(0, -1)">-</button>
    </div>
    
    <div class="instrucciones">
        @if (inicioSeleccion == null)
        {
            <span>Haz clic para iniciar cama</span>
        }
        else
        {
            <span class="esperando">Cierra la cama</span>
            <button class="btn-cancelar" @onclick="CancelarSeleccion">Cancelar</button>
        }
    </div>
</div>

<div class="grid-contenedor" 
     style="grid-template-columns: repeat(@Columnas, 60px); 
            grid-template-rows: repeat(@Filas, 60px);">
            
    @for (int r = 0; r < Filas; r++)
    {
        @for (int c = 0; c < Columnas; c++)
        {
            int fila = r; int col = c;
            var celda = Matriz[fila, col];
            
            // Clases para los Muros Rojos
            string claseMuros = "";
            if (celda.MuroTop) claseMuros += " muro-top";
            if (celda.MuroBottom) claseMuros += " muro-bottom";
            if (celda.MuroLeft) claseMuros += " muro-left";
            if (celda.MuroRight) claseMuros += " muro-right";

            <div class="casilla @ObtenerClase(celda, fila, col)" 
                 @onclick="() => AlClickarCasilla(fila, col)">
                
                @if (celda.Ocupado)
                {
                    <div class="contenido-celda @celda.EstiloCss @claseMuros">
                        <span class="modelo-tag">@celda.Modelo3D</span>
                        
                        <div class="indicadores-sticks">
                            @if(celda.StickUp) { <div class="stick stick-up"></div> }
                            @if(celda.StickDown) { <div class="stick stick-down"></div> }
                            @if(celda.StickLeft) { <div class="stick stick-left"></div> }
                            @if(celda.StickRight) { <div class="stick stick-right"></div> }
                        </div>

                        @if(celda.UneArriba) { <div class="union-dot u-top"></div> }
                        @if(celda.UneAbajo) { <div class="union-dot u-bottom"></div> }
                        @if(celda.UneIzq) { <div class="union-dot u-left"></div> }
                        @if(celda.UneDer) { <div class="union-dot u-right"></div> }
                        
                         @if(celda.Modelo3D == "Conector") { <div class="letra-c">C</div> }
                    </div>
                }
            </div>
        }
    }
</div>

<style>
    .panel-controles { margin-bottom: 15px; display: flex; gap: 15px; align-items: center; background: #eee; padding: 10px; border-radius: 5px;}
    .btn { padding: 2px 10px; cursor: pointer; }
    .btn-cancelar { margin-left: 10px; background: #ffcccc; border: 1px solid red; }
    .instrucciones { margin-left: auto; font-size: 0.9em; color: #555; }
    .esperando { color: blue; font-weight: bold; }

    .grid-contenedor { display: grid; gap: 1px; background-color: #333; border: 1px solid #999; width: fit-content; user-select: none; }
    
    .casilla { background-color: #f8f9fa; display: flex; align-items: center; justify-content: center; cursor: pointer; overflow: hidden; font-size: 0.8em; position: relative;}
    .contenido-celda { display: flex; flex-direction: column; align-items: center; justify-content: center; width: 100%; height: 100%; position: relative; }
    
    /* Estilos base */
    .estilo-lona { background-color: #bbdefb; color: #0d47a1; }
    .estilo-pad { background-color: #fff9c4; color: #f57f17; } /* Amarillo */
    .estilo-malla { background-color: #ffcdd2; color: #b71c1c; } /* Rojo */
    .estilo-conector { background-color: #e1bee7; color: #4a148c; border: 2px dashed #7b1fa2; } /* MORADO */

    /* MUROS ROJOS */
    .muro-top { border-top: 5px solid #b71c1c; }
    .muro-bottom { border-bottom: 5px solid #b71c1c; }
    .muro-left { border-left: 5px solid #b71c1c; }
    .muro-right { border-right: 5px solid #b71c1c; }

    .modelo-tag { font-weight: bold; font-size: 0.8em; z-index: 2; position: relative; top: -8px;}

    /* STICKS NEGROS */
    .stick { position: absolute; background-color: black; z-index: 1; }
    .stick-up { bottom: 50%; left: 50%; width: 2px; height: 15px; transform: translateX(-50%); }
    .stick-down { top: 50%; left: 50%; width: 2px; height: 15px; transform: translateX(-50%); }
    .stick-left { right: 50%; top: 50%; width: 15px; height: 2px; transform: translateY(-50%); }
    .stick-right { left: 50%; top: 50%; width: 15px; height: 2px; transform: translateY(-50%); }

    /* MARCAS DE UNIÓN (Puntos morados oscuros en el borde) */
    .union-dot { position: absolute; width: 8px; height: 8px; background-color: #4a148c; border-radius: 50%; z-index: 4; }
    .u-top { top: 2px; left: 50%; transform: translateX(-50%); }
    .u-bottom { bottom: 2px; left: 50%; transform: translateX(-50%); }
    .u-left { left: 2px; top: 50%; transform: translateY(-50%); }
    .u-right { right: 2px; top: 50%; transform: translateY(-50%); }

    .letra-c { position: absolute; font-size: 1.5em; font-weight: bold; color: rgba(74, 20, 140, 0.3); top: 50%; left: 50%; transform: translate(-50%, -40%); z-index: 0;}

    .casilla:hover { filter: brightness(0.95); }
    .seleccionando { background-color: #b3d9ff !important; }
</style>

@code {
    public class Celda
    {
        public bool Ocupado { get; set; } = false;
        public Guid RectanguloId { get; set; }
        public string Modelo3D { get; set; } = "";
        public string EstiloCss { get; set; } = "";
        
        public bool MuroTop { get; set; }
        public bool MuroBottom { get; set; }
        public bool MuroLeft { get; set; }
        public bool MuroRight { get; set; }

        public bool StickUp { get; set; }
        public bool StickDown { get; set; }
        public bool StickLeft { get; set; }
        public bool StickRight { get; set; }

        public bool UneArriba { get; set; }
        public bool UneAbajo { get; set; }
        public bool UneIzq { get; set; }
        public bool UneDer { get; set; }
    }

    public class Rectangulo
    {
        public Guid Id { get; set; } = Guid.NewGuid();
        public int FilaInicio { get; set; }
        public int FilaFin { get; set; }
        public int ColInicio { get; set; }
        public int ColFin { get; set; }
    }

    public int Filas { get; set; } = 8;
    public int Columnas { get; set; } = 10;
    public Celda[,] Matriz { get; set; } = new Celda[0,0];
    private List<Rectangulo> RectangulosActivos = new();
    private (int r, int c)? inicioSeleccion = null;

    protected override void OnInitialized() => ReconstruirMatriz();

    void AlClickarCasilla(int fila, int col)
    {
        if (Matriz[fila, col].Ocupado) return;
        if (inicioSeleccion == null) inicioSeleccion = (fila, col);
        else
        {
            var inicio = inicioSeleccion.Value;
            IntentarCrearRectangulo(inicio.r, inicio.c, fila, col);
            inicioSeleccion = null;
        }
    }

    void IntentarCrearRectangulo(int r1, int c1, int r2, int c2)
    {
        int rMin = Math.Min(r1, r2); int rMax = Math.Max(r1, r2);
        int cMin = Math.Min(c1, c2); int cMax = Math.Max(c1, c2);
        for (int r = rMin; r <= rMax; r++)
            for (int c = cMin; c <= cMax; c++)
                if (Matriz[r, c].Ocupado) return;

        RectangulosActivos.Add(new Rectangulo { FilaInicio = rMin, FilaFin = rMax, ColInicio = cMin, ColFin = cMax });
        ReconstruirMatriz();
    }

    void ReconstruirMatriz()
    {
        Matriz = new Celda[Filas, Columnas];
        for (int i = 0; i < Filas; i++) for (int j = 0; j < Columnas; j++) Matriz[i, j] = new Celda();

        foreach (var rect in RectangulosActivos)
            for (int r = rect.FilaInicio; r <= rect.FilaFin; r++)
                for (int c = rect.ColInicio; c <= rect.ColFin; c++)
                {
                    Matriz[r, c].Ocupado = true;
                    Matriz[r, c].RectanguloId = rect.Id;
                }

        foreach (var rect in RectangulosActivos) CalcularFase1_Basicos(rect);

        CalcularFase2_Conectores();
    }

    void CalcularFase1_Basicos(Rectangulo rect)
    {
        for (int r = rect.FilaInicio; r <= rect.FilaFin; r++)
        {
            for (int c = rect.ColInicio; c <= rect.ColFin; c++)
            {
                var celda = Matriz[r, c];
                
                // 1. STICKS (Geometría interna)
                bool esTop = (r == rect.FilaInicio);
                bool esBottom = (r == rect.FilaFin);
                bool esLeft = (c == rect.ColInicio);
                bool esRight = (c == rect.ColFin);

                if (esTop) celda.StickDown = true;
                if (esBottom) celda.StickUp = true;
                if (esLeft) celda.StickRight = true;
                if (esRight) celda.StickLeft = true;

                // 2. MUROS (Geometría externa)
                celda.MuroTop = EsVacio(r - 1, c);
                celda.MuroBottom = EsVacio(r + 1, c);
                celda.MuroLeft = EsVacio(r, c - 1);
                celda.MuroRight = EsVacio(r, c + 1);

                // 3. TIPO INICIAL
                if (!esTop && !esBottom && !esLeft && !esRight) {
                    celda.Modelo3D = "Lona";
                    celda.EstiloCss = "estilo-lona";
                }
                else if (celda.MuroTop || celda.MuroBottom || celda.MuroLeft || celda.MuroRight) {
                    celda.Modelo3D = "Malla";
                    celda.EstiloCss = "estilo-malla";
                }
                else {
                    celda.Modelo3D = "Pad";
                    celda.EstiloCss = "estilo-pad";
                }
            }
        }
    }

    void CalcularFase2_Conectores()
    {
        for (int r = 0; r < Filas; r++)
        {
            for (int c = 0; c < Columnas; c++)
            {
                var celda = Matriz[r, c];
                if (celda.Modelo3D != "Pad") continue;

                // Revisamos vecinos para ver si son Mallas
                bool mallaArriba = EsMalla(r - 1, c);
                bool mallaAbajo = EsMalla(r + 1, c);
                bool mallaIzq = EsMalla(r, c - 1);
                bool mallaDer = EsMalla(r, c + 1);

                
                bool esEsquina = (mallaArriba && mallaIzq) || 
                                 (mallaArriba && mallaDer) || 
                                 (mallaAbajo && mallaIzq) || 
                                 (mallaAbajo && mallaDer);

                if (esEsquina)
                {
                    celda.Modelo3D = "Conector";
                    celda.EstiloCss = "estilo-conector";
                    
                    // Marcamos visualmente hacia dónde conecta
                    celda.UneArriba = mallaArriba;
                    celda.UneAbajo = mallaAbajo;
                    celda.UneIzq = mallaIzq;
                    celda.UneDer = mallaDer;
                }
            }
        }
    }

    bool EsVacio(int r, int c)
    {
        if (r < 0 || r >= Filas || c < 0 || c >= Columnas) return true;
        return !Matriz[r, c].Ocupado;
    }

    bool EsMalla(int r, int c)
    {
        if (r < 0 || r >= Filas || c < 0 || c >= Columnas) return false;
        return Matriz[r, c].Modelo3D == "Malla";
    }

    void CambiarDimensiones(int deltaFila, int deltaCol)
    {
        if (Filas + deltaFila < 1 || Columnas + deltaCol < 1) return;
        Filas += deltaFila; Columnas += deltaCol;
        RectangulosActivos.RemoveAll(rect => rect.FilaFin >= Filas || rect.ColFin >= Columnas);
        ReconstruirMatriz();
    }
    void CancelarSeleccion() => inicioSeleccion = null;
    string ObtenerClase(Celda c, int r, int i) => (c.Ocupado ? "ocupada " : "") + (inicioSeleccion != null && inicioSeleccion.Value.r == r && inicioSeleccion.Value.c == i ? "seleccionando" : "");
}