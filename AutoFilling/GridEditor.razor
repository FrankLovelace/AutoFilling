@namespace AutoFilling

<div class="panel-controles">
    <div class="control-grupo">
        <label>Filas: <strong>@Filas</strong></label>
        <button class="btn" @onclick="() => CambiarDimensiones(1, 0)">+</button>
        <button class="btn" @onclick="() => CambiarDimensiones(-1, 0)">-</button>
    </div>

    <div class="control-grupo">
        <label>Columnas: <strong>@Columnas</strong></label>
        <button class="btn" @onclick="() => CambiarDimensiones(0, 1)">+</button>
        <button class="btn" @onclick="() => CambiarDimensiones(0, -1)">-</button>
    </div>
    
    <div class="instrucciones">
        @if (inicioSeleccion == null)
        {
            <span>Haz clic para iniciar cama</span>
        }
        else
        {
            <span class="esperando">Cierra la cama</span>
            <button class="btn-cancelar" @onclick="CancelarSeleccion">Cancelar</button>
        }
    </div>
</div>

<div class="grid-contenedor" 
     style="grid-template-columns: repeat(@Columnas, 60px); 
            grid-template-rows: repeat(@Filas, 60px);">
            
    @for (int r = 0; r < Filas; r++)
    {
        @for (int c = 0; c < Columnas; c++)
        {
            int fila = r; int col = c;
            var celda = Matriz[fila, col];
            
            <div class="casilla @ObtenerClase(celda, fila, col)" 
                 @onclick="() => AlClickarCasilla(fila, col)">
                @if (celda.Ocupado)
                {
                    <div class="contenido-celda @celda.EstiloCss">
                      
                        <span class="modelo-tag">@celda.Modelo3D</span>
                        
                        @if (celda.Modelo3D != "Lona") 
                        {
                            <span class="flecha" style="transform: rotate(@(celda.Rotacion)deg);">↑</span>
                            <span class="debug-rotacion">@celda.Rotacion°</span>
                        }
                    </div>
                }
            </div>
        }
    }
</div>

<style>
    .panel-controles { margin-bottom: 15px; display: flex; gap: 15px; align-items: center; background: #eee; padding: 10px; border-radius: 5px;}
    .btn { padding: 2px 10px; cursor: pointer; }
    .btn-cancelar { margin-left: 10px; background: #ffcccc; border: 1px solid red; }
    .instrucciones { margin-left: auto; font-size: 0.9em; color: #555; }
    .esperando { color: blue; font-weight: bold; }

    .grid-contenedor { display: grid; gap: 1px; background-color: #333; border: 1px solid #999; width: fit-content; user-select: none; }
    
    .casilla { background-color: #f8f9fa; display: flex; align-items: center; justify-content: center; cursor: pointer; overflow: hidden; font-size: 0.8em;}
    .contenido-celda { display: flex; flex-direction: column; align-items: center; justify-content: center; width: 100%; height: 100%; }
    
    /* Estilos visuales según tipo */
    .estilo-lona { background-color: #bbdefb; color: #0d47a1; } /* Azul claro */
    .estilo-pad { background-color: #fff9c4; color: #f57f17; } /* Amarillo (Unión) */
    .estilo-malla { background-color: #ffcdd2; color: #b71c1c; border: 2px solid #b71c1c; } /* Rojo (Peligro/Malla) */

    .modelo-tag { font-weight: bold; font-size: 0.9em; margin-bottom: 2px; text-align: center; }
    .flecha { font-size: 1.5em; color: inherit; display: block; transition: transform 0.3s ease; line-height: 0.8; opacity: 0.7; }
    .debug-rotacion { font-size: 0.7em; opacity: 0.5; }

    .casilla:hover { filter: brightness(0.95); }
    .seleccionando { background-color: #b3d9ff !important; }
</style>

@code {
    public class Celda
    {
        public bool Ocupado { get; set; } = false;
        public Guid RectanguloId { get; set; }
        
        public string Modelo3D { get; set; } = ""; 
        public int Rotacion { get; set; } 
        
        public string EstiloCss { get; set; } = "";
    }

    public class Rectangulo
    {
        public Guid Id { get; set; } = Guid.NewGuid();
        public int FilaInicio { get; set; }
        public int FilaFin { get; set; }
        public int ColInicio { get; set; }
        public int ColFin { get; set; }
    }

    public int Filas { get; set; } = 8;
    public int Columnas { get; set; } = 10;
    public Celda[,] Matriz { get; set; } = new Celda[0,0];
    private List<Rectangulo> RectangulosActivos = new();
    private (int r, int c)? inicioSeleccion = null;

    protected override void OnInitialized() => ReconstruirMatriz();

    void AlClickarCasilla(int fila, int col)
    {
        if (Matriz[fila, col].Ocupado) return;
        if (inicioSeleccion == null) inicioSeleccion = (fila, col);
        else
        {
            var inicio = inicioSeleccion.Value;
            IntentarCrearRectangulo(inicio.r, inicio.c, fila, col);
            inicioSeleccion = null;
        }
    }

    void IntentarCrearRectangulo(int r1, int c1, int r2, int c2)
    {
        int rMin = Math.Min(r1, r2); int rMax = Math.Max(r1, r2);
        int cMin = Math.Min(c1, c2); int cMax = Math.Max(c1, c2);

        for (int r = rMin; r <= rMax; r++)
            for (int c = cMin; c <= cMax; c++)
                if (Matriz[r, c].Ocupado) return;

        RectangulosActivos.Add(new Rectangulo { FilaInicio = rMin, FilaFin = rMax, ColInicio = cMin, ColFin = cMax });
        ReconstruirMatriz();
    }

    void ReconstruirMatriz()
    {
        Matriz = new Celda[Filas, Columnas];
        for (int i = 0; i < Filas; i++)
            for (int j = 0; j < Columnas; j++)
                Matriz[i, j] = new Celda();

        // 1. Llenar ocupación base
        foreach (var rect in RectangulosActivos)
        {
            for (int r = rect.FilaInicio; r <= rect.FilaFin; r++)
                for (int c = rect.ColInicio; c <= rect.ColFin; c++)
                {
                    Matriz[r, c].Ocupado = true;
                    Matriz[r, c].RectanguloId = rect.Id;
                }
        }

        // 2. Calcular Lógica de Perímetro
        foreach (var rect in RectangulosActivos)
        {
            CalcularLogicaRectangulo(rect);
        }
    }

    void CalcularLogicaRectangulo(Rectangulo rect)
    {
        for (int r = rect.FilaInicio; r <= rect.FilaFin; r++)
        {
            for (int c = rect.ColInicio; c <= rect.ColFin; c++)
            {
                var celda = Matriz[r, c];
                
                // Determinar si soy Borde de MI rectángulo
                bool esTop = (r == rect.FilaInicio);
                bool esBottom = (r == rect.FilaFin);
                bool esLeft = (c == rect.ColInicio);
                bool esRight = (c == rect.ColFin);

                if (!esTop && !esBottom && !esLeft && !esRight)
                {
                    // SOY CENTRO (Lona de salto)
                    celda.Modelo3D = "Lona";
                    celda.EstiloCss = "estilo-lona";
                    celda.Rotacion = 0; 
                    continue;
                }

                
                bool necesitoMalla = false;

                
                
                if (esTop)
                {
                    celda.Rotacion = 180; 
                    necesitoMalla = EsVacio(r - 1, c); 
                }
                else if (esBottom)
                {
                    celda.Rotacion = 0; 
                    necesitoMalla = EsVacio(r + 1, c);
                }
                else if (esLeft)
                {
                    celda.Rotacion = 90;
                    necesitoMalla = EsVacio(r, c - 1);
                }
                else if (esRight)
                {
                    celda.Rotacion = 270;
                    necesitoMalla = EsVacio(r, c + 1);
                }

               
                if (esTop && esLeft) 
                {
                     necesitoMalla = EsVacio(r - 1, c) || EsVacio(r, c - 1);
                     celda.Rotacion = 135; 
                }
                else if (esTop && esRight) { necesitoMalla = EsVacio(r - 1, c) || EsVacio(r, c + 1); celda.Rotacion = 225; }
                else if (esBottom && esRight) { necesitoMalla = EsVacio(r + 1, c) || EsVacio(r, c + 1); celda.Rotacion = 315; }
                else if (esBottom && esLeft) { necesitoMalla = EsVacio(r + 1, c) || EsVacio(r, c - 1); celda.Rotacion = 45; }

                if (necesitoMalla)
                {
                    celda.Modelo3D = "Malla";
                    celda.EstiloCss = "estilo-malla";
                }
                else
                {
                    celda.Modelo3D = "Pad"; 
                    celda.EstiloCss = "estilo-pad";
                }
            }
        }
    }

    bool EsVacio(int r, int c)
    {
        if (r < 0 || r >= Filas || c < 0 || c >= Columnas) return true;
        
        return !Matriz[r, c].Ocupado;
    }

    void CambiarDimensiones(int deltaFila, int deltaCol)
    {
        if (Filas + deltaFila < 1 || Columnas + deltaCol < 1) return;
        Filas += deltaFila; Columnas += deltaCol;
        RectangulosActivos.RemoveAll(rect => rect.FilaFin >= Filas || rect.ColFin >= Columnas);
        ReconstruirMatriz();
    }
    void CancelarSeleccion() => inicioSeleccion = null;
    string ObtenerClase(Celda c, int r, int i) => (c.Ocupado ? "ocupada " : "") + (inicioSeleccion != null && inicioSeleccion.Value.r == r && inicioSeleccion.Value.c == i ? "seleccionando" : "");
}